import { ApifyClient } from 'apify-client';

// Apify í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
const apifyClient = new ApifyClient({
  token: process.env.APIFY_API_TOKEN,
});

/**
 * YouTube ì±„ë„ ë¶„ì„ ìœ í‹¸ë¦¬í‹° (Apify ê¸°ë°˜)
 */

// ğŸ“Š YouTube ì˜ìƒ ì •ë³´ íƒ€ì… (Apify ì‹¤ì œ êµ¬ì¡°ì— ë§ì¶˜ íƒ€ì…)
export interface YouTubeVideo {
  id: string;
  title: string;
  description: string;
  published_at: string;
  view_count: number;
  duration_seconds: number;
  url: string;
  transcript?: string;
  channel_id: string;
  channel_title: string;
  
  // Apify ì›ë³¸ í•„ë“œë“¤ (AI ë¶„ì„ìš©)
  channelName?: string;
  numberOfSubscribers?: number;
  channelTotalVideos?: number;
  channelDescription?: string;
  viewCount?: number;
  likes?: number;
  commentsCount?: number;
  date?: string;
  text?: string;
  subtitles?: Array<{
    language?: string;
    plaintext?: string;
    type?: string;
  }>;
}

// ğŸ“ˆ ì±„ë„ ë¶„ì„ ê²°ê³¼ íƒ€ì…
export interface ChannelAnalysisResult {
  channel_info: {
  id: string;
  title: string;
    url: string;
  };
  videos: YouTubeVideo[];
  analysis_summary: {
    total_videos: number;
    videos_with_subtitles: number;
    avg_duration_minutes: number;
    total_views: number;
    latest_video_date: string;
  };
}

/**
 * ğŸ” YouTube URL ê²€ì¦
 */
export function extractChannelInfo(url: string): { type: string; url: string } | null {
  try {
    if (!url.includes('youtube.com') && !url.includes('youtu.be')) {
      return null;
    }

    // ë‹¤ì–‘í•œ URL í˜•íƒœ ì§€ì›
    if (url.includes('/watch?v=') || url.includes('youtu.be/')) {
      return { type: 'video', url };
    }
    
    if (url.includes('/channel/') || url.includes('/c/') || url.includes('/@')) {
      return { type: 'channel', url };
    }

    return { type: 'unknown', url };
  } catch {
    return null;
  }
}

/**
 * ğŸ¯ YouTube ì±„ë„ ë¶„ì„ (ìë§‰ í¬í•¨)
 */
export async function analyzeYouTubeChannel(
  channelUrl: string, 
  maxVideos: number = 5
): Promise<ChannelAnalysisResult> {
  try {
    // URL ê²€ì¦
    const channelInfo = extractChannelInfo(channelUrl);
    if (!channelInfo) {
      throw new Error('ì˜¬ë°”ë¥¸ YouTube URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    }

    // API í† í° í™•ì¸
    if (!process.env.APIFY_API_TOKEN || process.env.APIFY_API_TOKEN === 'your_apify_api_token_here') {
      throw new Error('Apify API í† í°ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
    }

    console.log(`ğŸ” ì±„ë„ ë¶„ì„ ì‹œì‘: ${maxVideos}ê°œ ì˜ìƒ (ìë§‰ í¬í•¨)`);

    // ğŸ¬ Apify YouTube Scraper ì‹¤í–‰
    const input = {
      downloadSubtitles: true,
      hasCC: false,
      hasLocation: false,
      hasSubtitles: false,
      is360: false,
      is3D: false,
      is4K: false,
      isBought: false,
      isHD: false,
      isHDR: false,
      isLive: false,
      isVR180: false,
      maxResultStreams: 0,
      maxResults: maxVideos,
      maxResultsShorts: 0,
      preferAutoGeneratedSubtitles: true,
      saveSubsToKVS: false,
      startUrls: [
        {
          url: channelUrl,
          method: "GET"
        }
      ],
      subtitlesFormat: "plaintext",
      subtitlesLanguage: "any",
      videoType: "video"
    };

    const run = await apifyClient.actor("h7sDV53CddomktSi5").call(input);

    // ê²°ê³¼ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    const { items } = await apifyClient.dataset(run.defaultDatasetId).listItems();  
    console.log(items);
    
    if (!items || items.length === 0) {
      throw new Error('ì±„ë„ì—ì„œ ì˜ìƒì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }

    console.log(`ğŸ“Š ${items.length}ê°œ ì˜ìƒ ë°ì´í„° ìˆ˜ì§‘ë¨`);

    // ğŸ”§ ë°ì´í„° ì •ë¦¬ ë° ë³€í™˜
    const videos: YouTubeVideo[] = items.map((item: Record<string, unknown>) => {
      // ğŸ“ ìë§‰ ì²˜ë¦¬
      let transcript = undefined;
      
      if (item.subtitles && Array.isArray(item.subtitles) && item.subtitles.length > 0) {
        console.log(`ğŸŒ ${item.title}: ${item.subtitles.length}ê°œ ì–¸ì–´ ìë§‰ ë°œê²¬`);
        
        // ì–¸ì–´ ìš°ì„ ìˆœìœ„: í•œêµ­ì–´ â†’ ì˜ì–´ â†’ ìë™ìƒì„± â†’ ê¸°íƒ€
        const priorityLanguages = ['ko', 'kr', 'korean', 'en', 'english', 'auto'];
        let selectedSubtitle = null;
        
        // ìš°ì„ ìˆœìœ„ì— ë”°ë¼ ìë§‰ ì„ íƒ
        for (const lang of priorityLanguages) {
          selectedSubtitle = item.subtitles.find((sub: Record<string, unknown>) => {
            const langCode = String(sub.language || sub.languageCode || '').toLowerCase();
            const subType = String(sub.type || '').toLowerCase();
            
            if (lang === 'ko' && langCode === 'ko') return true;
            if (lang === 'kr' && (langCode === 'kr' || langCode.includes('kr'))) return true;
            if (lang === 'korean' && langCode.includes('korean')) return true;
            if (lang === 'en' && langCode === 'en') return true;
            if (lang === 'english' && langCode.includes('english')) return true;
            if (lang === 'auto' && subType.includes('auto')) return true;
            
            return false;
          });
          if (selectedSubtitle) {
            console.log(`âœ… ì„ íƒëœ ì–¸ì–´: ${selectedSubtitle.language || selectedSubtitle.languageCode || 'unknown'}`);
            break;
          }
        }
        
        // ìš°ì„ ìˆœìœ„ ì–¸ì–´ê°€ ì—†ìœ¼ë©´ ì²« ë²ˆì§¸ ìë§‰ ì‚¬ìš©
        if (!selectedSubtitle && item.subtitles[0]) {
          selectedSubtitle = item.subtitles[0];
          console.log(`ğŸ“ ê¸°ë³¸ ìë§‰ ì‚¬ìš©: ${selectedSubtitle.language || 'unknown'}`);
        }
        
        // ìë§‰ í…ìŠ¤íŠ¸ ì¶”ì¶œ ë° ì •ë¦¬
        if (selectedSubtitle) {
          transcript = selectedSubtitle.plaintext || selectedSubtitle.text || selectedSubtitle.content;
          
          if (transcript && transcript.length > 50) {
            transcript = transcript
            .replace(/\d+\n\d{2}:\d{2}:\d{2},\d{3} --> \d{2}:\d{2}:\d{2},\d{3}\n/g, '')
            .replace(/\n+/g, ' ')
            .replace(/\s+/g, ' ')
              .replace(/[^\w\sê°€-í£.,!?]/g, ' ')
            .trim();
            
            // ë„ˆë¬´ ì§§ì€ ìë§‰ì€ ì œì™¸
            if (transcript.length < 100) {
              transcript = undefined;
            }
          } else {
            transcript = undefined;
          }
        }
      }

      return {
        // ê¸°ë³¸ í•„ë“œë“¤ (ê¸°ì¡´ í˜¸í™˜ì„± ìœ ì§€)
        id: String(item.id || item.videoId || ''),
        title: String(item.title || 'ì œëª© ì—†ìŒ'),
        description: String(item.text || item.description || ''),
        published_at: String(item.date || item.publishedAt || ''),
        view_count: Number(item.viewCount) || 0,
        duration_seconds: Number(item.lengthSeconds) || 0,
        url: String(item.url || `https://youtube.com/watch?v=${item.id || item.videoId}`),
        transcript,
        channel_id: String(item.channelId || ''),
        channel_title: String(item.channelName || item.channelTitle || ''),
        
        // Apify ì›ë³¸ í•„ë“œë“¤ (AI ë¶„ì„ìš©)
        channelName: item.channelName ? String(item.channelName) : undefined,
        numberOfSubscribers: item.numberOfSubscribers ? Number(item.numberOfSubscribers) : undefined,
        channelTotalVideos: item.channelTotalVideos ? Number(item.channelTotalVideos) : undefined,
        channelDescription: item.channelDescription ? String(item.channelDescription) : undefined,
        viewCount: item.viewCount ? Number(item.viewCount) : undefined,
        likes: item.likes ? Number(item.likes) : undefined,
        commentsCount: item.commentsCount ? Number(item.commentsCount) : undefined,
        date: item.date ? String(item.date) : undefined,
        text: item.text ? String(item.text) : undefined,
        subtitles: Array.isArray(item.subtitles) ? item.subtitles as Array<{
          language?: string;
          plaintext?: string;
          type?: string;
        }> : undefined
      };
    });

    // ğŸ“Š ë¶„ì„ ìš”ì•½ ìƒì„±
    const videosWithSubtitles = videos.filter(v => v.transcript && v.transcript.length > 100);
    const totalViews = videos.reduce((sum, v) => sum + v.view_count, 0);
    const avgDuration = videos.length > 0 
      ? Math.round(videos.reduce((sum, v) => sum + v.duration_seconds, 0) / videos.length / 60)
      : 0;

    const result: ChannelAnalysisResult = {
      channel_info: {
        id: videos[0]?.channel_id || '',
        title: videos[0]?.channel_title || 'ì±„ë„ëª… ë¯¸ìƒ',
        url: channelUrl
      },
      videos,
      analysis_summary: {
        total_videos: videos.length,
        videos_with_subtitles: videosWithSubtitles.length,
        avg_duration_minutes: avgDuration,
        total_views: totalViews,
        latest_video_date: videos[0]?.published_at || ''
      }
    };

    console.log(`âœ… ë¶„ì„ ì™„ë£Œ: ${videos.length}ê°œ ì˜ìƒ, ${videosWithSubtitles.length}ê°œ ìë§‰`);
    
    return result;

  } catch (error: unknown) {
    const errorMessage = error instanceof Error ? error.message : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜';
    console.error('âŒ ì±„ë„ ë¶„ì„ ì‹¤íŒ¨:', errorMessage);
    throw new Error(`ì±„ë„ ë¶„ì„ ì‹¤íŒ¨: ${errorMessage}`);
  }
}

/**
 * ğŸ”§ Apify ì„œë¹„ìŠ¤ ì‚¬ìš© ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
 */
export function isApifyAvailable(): boolean {
  const token = process.env.APIFY_API_TOKEN;
  return !!(token && token !== 'your_apify_api_token_here');
}

// ğŸ¯ ê°„ë‹¨í•œ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
export const utils = {
  // ì˜ìƒ ê¸¸ì´ë¥¼ "MM:SS" í˜•íƒœë¡œ ë³€í™˜
  formatDuration: (seconds: number): string => {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  },

  // ì¡°íšŒìˆ˜ë¥¼ ê°„ë‹¨í•œ í˜•íƒœë¡œ ë³€í™˜ (1.2M, 34K ë“±)
  formatViewCount: (views: number): string => {
    if (views >= 1000000) return `${(views / 1000000).toFixed(1)}M`;
    if (views >= 1000) return `${(views / 1000).toFixed(1)}K`;
    return views.toString();
  },

  // ë‚ ì§œë¥¼ ìƒëŒ€ì  ì‹œê°„ìœ¼ë¡œ ë³€í™˜
  formatRelativeDate: (dateString: string): string => {
    try {
      const date = new Date(dateString);
      const now = new Date();
      const diffDays = Math.floor((now.getTime() - date.getTime()) / (1000 * 60 * 60 * 24));
      
      if (diffDays === 0) return 'ì˜¤ëŠ˜';
      if (diffDays === 1) return 'ì–´ì œ';
      if (diffDays < 7) return `${diffDays}ì¼ ì „`;
      if (diffDays < 30) return `${Math.floor(diffDays / 7)}ì£¼ ì „`;
      if (diffDays < 365) return `${Math.floor(diffDays / 30)}ê°œì›” ì „`;
      return `${Math.floor(diffDays / 365)}ë…„ ì „`;
    } catch {
      return dateString;
    }
  },

  // ğŸ“ ìë§‰ í…ìŠ¤íŠ¸ ìš”ì•½ (ì²˜ìŒ Nìë§Œ)
  summarizeTranscript: (transcript: string, maxLength: number = 200): string => {
    if (!transcript) return '';
    if (transcript.length <= maxLength) return transcript;
    
    // ë¬¸ì¥ ë‹¨ìœ„ë¡œ ìë¥´ê¸°
    const sentences = transcript.split(/[.!?]+/).filter(s => s.trim().length > 0);
    let summary = '';
    
    for (const sentence of sentences) {
      if ((summary + sentence).length > maxLength) break;
      summary += sentence.trim() + '. ';
    }
    
    return summary.trim() + '...';
  }
}; 